```{r chapter-5-setup, cache = FALSE, echo = FALSE, message = FALSE, warning = FALSE}

library(data.table)
library(tidyverse)
library(hrbrthemes)
library(ggcorrplot)
library(GoodmanKruskal)
library(lindia)
library(finalfit)
library(sigr)
library(papaja)
library(here)
library(kableExtra)
library(GGally)
library(gtools)
library(MASS)
library(corrplot)
library(magrittr)
library(caret)
library(factoextra)
library(broom)
library(ggord)
library(skimr)
library(sjstats)
library(explor)
library(stargazer)
# For overriding MASS select() 
select <- dplyr::select
set.seed(2018)
```


# Week 6 â€“ Analysis of longitudinal data


```{r chapter-8-generic-instruction, echo = FALSE}
# Implement the analyses of Chapter 8 of MABS using the RATS data. (0-7 points)
```


```{r chapter6-load-data, echo = FALSE, message=FALSE}

rats <- fread(here("data/rats.csv"))
rats_raw <- fread(here("data/rats.txt"))
rats_raw %<>% select(-V1)

rats %<>% mutate(
  id = factor(id),
  group = factor(group),
  weeks = factor(weeks)
)


```

```{r rats-overview, echo = FALSE}
skim(rats)
```


## Figure 8.1

```{r rats-81, echo = FALSE}
ggplot(rats, aes(x = time, y = rats, linetype = id)) + 
  geom_line() + scale_linetype_manual(values = rep(1:10, times=4)) + 
  facet_grid(. ~ group, labeller = label_both) +
  theme_minimal() + theme(legend.position = "none") +
  theme(panel.grid.minor.y = element_blank()) +
  scale_y_continuous(limits = c(min(rats$rats), max(rats$rats)))

```
\pagebreak

## Figure 8.2

```{r rats-82, echo=FALSE}
# Standardise the scores:
rats %<>%
  group_by(time) %>%
  mutate(stdrats = (rats - mean(rats))/sd(rats)) %>%
  ungroup()

skim(rats)
ggplot(rats , aes(x = time, y = stdrats, linetype = id)) + 
  geom_line() + scale_linetype_manual(values = rep(1:10, times = 4)) +
  facet_grid(. ~ group, labeller = label_both) +
  theme_minimal() + theme(legend.position = "none") +
  theme(panel.grid.minor.y = element_blank()) +
  scale_y_continuous(name = "standardized rats")

```
\pagebreak

## Figure 8.3

```{r rats-83, echo=FALSE}
# Make a summary data:
n <- length(0:8) # weeks, incl. baseline (0)
rats_summary <- rats %>%
  group_by(group, time) %>%
  summarise(mean = mean(rats), se = sd(rats)/sqrt(n)) %>%
  ungroup()

skim(rats_summary)

ggplot(rats_summary, aes(x = time, y = mean, linetype = group, shape = group)) +
  geom_line() + scale_linetype_manual(values = c(1,2,3)) +
  geom_point(size = 3) + scale_shape_manual(values = c(1,2,3)) +
  geom_errorbar(aes(ymin=mean-se, ymax = mean+se, linetype = "1"), width=0.3) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    ) +
  theme(legend.position = c(0.8,0.8)) +
  scale_y_continuous(name = "mean(rats) +/- se(rats)")
```

## Figure 8.4

```{r rats-8-4, echo = FALSE}
ggplot(rats, aes(x = factor(time), y = rats, fill = group)) +
  geom_boxplot(position = position_dodge(width = 0.9)) +
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  theme(legend.position = c(0.8,0.8)) +
  scale_x_discrete(name = "week")

```

## Figure 8.5


```{r rats-8-5, echo=TFALSE}
# Make a summary data of the post treatment weeks (8<)
rats_post <- rats %>%
  filter(time > 1) %>%
  group_by(group, id) %>%
  summarise(mean=mean(rats)) %>%
  ungroup()
glimpse(rats_post)

ggplot(rats_post, aes(x = group, y = mean)) +
  geom_boxplot() +
  theme_bw() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  stat_summary(
    fun.y = "mean",
    geom = "point",
    shape = 23,
    size = 4,
    fill = "white"
    ) +
  scale_y_continuous(name = "mean(rats), weeks 8<")

```

## Figure 8.6

```{r rats-8-6, echo=FALSE}
# Remove the outlier:
rats_post %<>% filter(mean < 550)
glimpse(rats_post)
ggplot(rats_post, aes(x = group, y = mean)) +
  geom_boxplot() +
  theme_bw() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    ) +
  stat_summary(
    fun.y = "mean",
    geom = "point",
    shape = 23,
    size = 4,
    fill = "white"
    ) +
  scale_y_continuous(name = "mean(rats), weeks 8>")

```

## Table 8.3

```{r Table 8.3, echo=TRUE}
# Without the outlier, apply Student's t-test, two-sided:
t.test(mean ~ group, data = rats_post, var.equal = TRUE)
```

## Table 8.4

```{r Table 8.4, echo=TRUE}
# Add the baseline from the original data as a new variable to the summary data:
baseline <- rats_raw$WD1
rats_post %<>%
  mutate(baseline)
# Fit the ANCOVA model and see the results:
fit <- lm(mean ~ baseline + group, data = rats_post)
summary(fit)
anova(fit)
```


```{r chapter9-generic-instruction, echo = FALSE}
# Implement the analyses of Chapter 9 of MABS using the BPRS data. (0-8 points)
```

